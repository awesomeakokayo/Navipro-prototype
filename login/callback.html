<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication Callback</title>
</head>
<body>
    <p id="status">Processing login...</p>
    <script src="config.js"></script>
    <script>
        // Helper: get URL query param
        function getQueryParam(param) {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get(param);
            } catch (e) {
                return null;
            }
        }

        // Helper: get hash fragment param
        function getHashParam(param) {
            try {
                const hashParams = new URLSearchParams(window.location.hash.substring(1));
                return hashParams.get(param);
            } catch (e) {
                return null;
            }
        }

        // Try extracting token/user_id from a full URL (useful when token is embedded inside redirectUrl)
        function extractFromUrlString(urlStr) {
            try {
                const u = new URL(urlStr);
                const qp = new URLSearchParams(u.search);
                const hp = u.hash ? new URLSearchParams(u.hash.substring(1)) : new URLSearchParams();
                return {
                    token: qp.get('token') || qp.get('access_token') || hp.get('token') || hp.get('access_token') || null,
                    userId: qp.get('user_id') || qp.get('userId') || qp.get('id') || hp.get('user_id') || hp.get('userId') || hp.get('id') || null
                };
            } catch (e) {
                return { token: null, userId: null };
            }
        }

        async function handleCallback() {
            console.log('[callback] starting callback handler. fullUrl:', window.location.href);
            try {
                // 1) Extract token and userId directly from query/hash
                let token = getQueryParam('token') || getHashParam('token') || getQueryParam('access_token') || getHashParam('access_token') || null;
                let userId = getQueryParam('user_id') || getHashParam('user_id') || getQueryParam('userId') || getHashParam('userId') || getQueryParam('id') || getHashParam('id') || null;
                console.log('[callback] direct params -> hasToken:', !!token, 'hasUserId:', !!userId);

                // 2) Maybe backend included a redirectUrl param which itself contains token/userId
                if (!token || !userId) {
                    const redirectUrl = getQueryParam('redirectUrl') || getQueryParam('redirect') || getQueryParam('redirect_uri');
                    if (redirectUrl) {
                        const extracted = extractFromUrlString(decodeURIComponent(redirectUrl));
                        token = token || extracted.token;
                        userId = userId || extracted.userId;
                        console.log('[callback] extracted from redirectUrl -> hasToken:', !!token, 'hasUserId:', !!userId);
                    }
                }

                // 3) If still no token, maybe backend set a cookie session â€” try /auth/me without Authorization
                if (!token) {
                    console.log('[callback] no token in URL, attempting cookie-based /auth/me lookup');
                    try {
                        const res = await fetch(`${backendURL}/auth/me`, { headers: { 'Content-Type': 'application/json' }, credentials: 'include' });
                        if (res.ok) {
                            const userData = await res.json();
                            const maybeToken = userData?.access_token || userData?.token || null;
                            const maybeId = userData?.user_id || userData?.userId || userData?.id || (userData.user && (userData.user.id || userData.user._id)) || null;
                            if (maybeToken) {
                                token = token || maybeToken;
                                console.log('[callback] obtained token from /auth/me response');
                            }
                            if (maybeId) {
                                userId = userId || maybeId;
                                console.log('[callback] obtained user_id from /auth/me response:', userId);
                            }
                        } else {
                            console.log('[callback] /auth/me cookie lookup returned status', res.status);
                        }
                    } catch (e) {
                        console.warn('[callback] /auth/me cookie lookup failed', e);
                    }
                }

                if (!token) {
                    throw new Error('No token could be extracted from callback URL or server');
                }

                // Store token under all keys used across app
                localStorage.setItem('token', token);
                localStorage.setItem('access_token', token);
                localStorage.setItem('jwt', token);
                console.log('[callback] token stored under token/access_token/jwt');

                // If we already have userId from params, persist and skip /auth/me fetch
                if (userId) {
                    localStorage.setItem('user_id', userId);
                    localStorage.setItem('userId', userId);
                    console.log('[callback] user_id stored from URL params:', userId);
                } else {
                    // Try to fetch user info using the token to obtain userId
                    try {
                        const response = await fetch(`${backendURL}/auth/me`, {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        if (response.ok) {
                            const userData = await response.json();
                            const fetchedId = userData?.user_id || userData?.userId || userData?.id || (userData.user && (userData.user.id || userData.user._id)) || null;
                            if (fetchedId) {
                                userId = fetchedId;
                                localStorage.setItem('user_id', userId);
                                localStorage.setItem('userId', userId);
                                console.log('[callback] user_id stored from /auth/me:', userId);
                            } else {
                                console.log('[callback] /auth/me returned no user_id in body');
                            }
                        } else {
                            console.warn('[callback] /auth/me returned non-OK status', response.status);
                        }
                    } catch (e) {
                        console.warn('[callback] fetch /auth/me with bearer token failed', e);
                    }
                }

                // Redirect to dashboard (token and possibly user_id now stored)
                // Prefer a redirectUrl param if provided by backend, else local dashboard
                const preferredRedirect = getQueryParam('redirectUrl') || getQueryParam('redirect') || getQueryParam('redirect_uri') || '../Dashboard/index.html';
                // Use replace so the fragment/query with token doesn't stay in history
                window.location.replace(preferredRedirect);
            } catch (error) {
                console.error('[callback] Auth callback error:', error);
                document.getElementById('status').textContent = 'Authentication failed. Redirecting to login...';
                setTimeout(() => { window.location.href = './index.html'; }, 2000);
            }
        }

        // Start processing immediately
        handleCallback();
    </script>
</body>
</html>